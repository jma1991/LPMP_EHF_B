---
title: "Atlas neighbors"
author: "James Ashmore"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

Setup chunk options:

```{r}
knitr::opts_chunk$set(
  autodep    = TRUE,
  cache      = TRUE,
  cache.lazy = FALSE,
  cache.path = "cache/11-atlas-neighbors.Rmd/",
  dev        = "png",
  error      = FALSE,
  message    = FALSE,
  warning    = FALSE,
  fig.align = "center",
  out.width = '100%'
)
```

Load Bioconductor packages:

```{r}
library(batchelor)
library(BiocNeighbors)
library(MouseGastrulationData)
library(scater)
library(scran)
```

Load CRAN packages:

```{r}
library(ggforce)
library(pheatmap)
```

Source user functions:

```{r}
source("code/splitByCol.R")
source("code/Mode.R")
```

## Neighbors

Read experiment object:

```{r}
sce <- readRDS("output/10-atlas-integration.rds")
```

Define source annotation:

```{r}
sce$source <- "reference"

sce$source[sce$batch == "LPMP_EHF"] <- "query"
```

Split experiment object by source:

```{r}
sce <- splitByCol(sce, sce$source)
```

Extract corrected PCA matrix for reference and query data:

```{r}
dim <- list(
  reference = reducedDim(sce$reference, "corrected"),
  query = reducedDim(sce$query, "corrected")
)
```

Find k nearest neighbors in reference data for each point in query data:

```{r}
set.seed(984529644)

knn <- queryKNN(X = dim$reference, query = dim$query, k = 10)
```

Create matrix of k nearest neighbor annotations:
  
```{r}
knn$stage <- structure(sce$reference$stage[knn$index], .Dim = dim(knn$index))

knn$celltype <- structure(sce$reference$celltype[knn$index], .Dim = dim(knn$index))
```


```{r}
idx <- (sce$reference$stage %in% knn$stage) & (sce$reference$celltype %in% knn$celltype)

sce <- cbind(sce$reference[, idx], sce$query)
```

## Integration

Model the per-gene variance:

```{r}
dec <- modelGeneVar(sce, block = sce$sample)
```

Extract blacklist genes used for feature selection:

```{r}
var <- metadata(sce)$combineVar

dec$blacklist <- var[rownames(dec), "blacklist"]
```

Identify highly variable genes:

```{r}
hvg <- subset(dec, blacklist == FALSE)

hvg <- getTopHVGs(hvg, var.field = "bio", var.threshold = 0, fdr.field = "p.value", fdr.threshold = 0.05)
```

Create sequential merge order:

```{r}
idx <- as.data.frame(table(sce$sample, sce$stage), stringsAsFactors = FALSE)

colnames(idx) <- c("sample", "stage", "ncells")

idx <- subset(idx, (sample %in% AtlasSampleMetadata$sample) & (ncells > 0))

lvl <- c("E6.5", "E6.75", "E7.0", "mixed_gastrulation", "E7.25", "E7.5", "E7.75", "E8.0", "E8.25", "E8.5")

idx$stage <- factor(idx$stage, levels = lvl)

idx <- idx[order(idx$stage, idx$ncells, decreasing = TRUE), ]

idx <- c(idx$sample, "LPMP_EHF")
```

Correct experiments using nearest neighbours:

```{r}
set.seed(498475642)

mnn <- correctExperiments(
  sce,
  batch = sce$sample,
  subset.row = hvg,
  correct.all = TRUE,
  PARAM = FastMnnParam(merge.order = idx)
)
```

```{r}
set.seed(42)

mnn <- runUMAP(mnn, dimred = "corrected", n_neighbors = 20, min_dist = 0.7) # same settings as reference analysis
```

Split experiment object by source:

```{r}
mnn <- splitByCol(mnn, mnn$source)
```

Extract corrected PCA matrix for reference and query data:

```{r}
dim <- list(
  reference = reducedDim(mnn$reference, "corrected"),
  query = reducedDim(mnn$query, "corrected")
)
```

Find k nearest neighbors in reference data for each point in query data:

```{r}
set.seed(984529644)

knn <- queryKNN(X = dim$reference, query = dim$query, k = 10)
```

Create matrix of k nearest neighbor annotations:
  
```{r}
knn$cell <- structure(mnn$reference$cell[knn$index], .Dim = dim(knn$index))

knn$stage <- structure(mnn$reference$stage[knn$index], .Dim = dim(knn$index))

knn$celltype <- structure(mnn$reference$celltype[knn$index], .Dim = dim(knn$index))
```

Annotate query data with k nearest neighbor annotations:
  
```{r}
mnn$reference$cell.mapped <- mnn$reference$cell
mnn$query$cell.mapped <- as.list(as.data.frame(apply(knn$cell, 1, head, n = 10)))

mnn$reference$stage.mapped <- mnn$reference$stage
mnn$query$stage.mapped <- apply(knn$stage, 1, Mode)

mnn$reference$celltype.mapped <- mnn$reference$celltype
mnn$query$celltype.mapped <- apply(knn$celltype, 1, Mode)
```

Select query cells and k nearest neighbor cells:
  
```{r}
idx <- mnn$reference$cell %in% unlist(mnn$query$cell.mapped)

mnn <- cbind(mnn$reference[, idx], mnn$query)
```






Store combined variance model:

```{r}
metadata(mnn)$modelGeneVar <- dec
```

Store highly variable genes:

```{r}
metadata(mnn)$getTopHVGs <- hvg
```

## Diagnostics

Check proportion of lost variance:

```{r fig.width = 8, fig.height = 6}
var <- metadata(mnn)$merge.info$lost.var

col <- colorRampPalette(RColorBrewer::brewer.pal(n = 5, name = "Reds"))(100)

brk <- seq(0, max(var), length.out = 101)

pheatmap(var[, idx], color = col, display_numbers = TRUE, number_format = "%.2f", cluster_cols = FALSE, cluster_rows = FALSE, angle_col = 0)
```

Cluster on the corrected PCA to obtain a partitioning of the cells:

```{r}
snn <- buildSNNGraph(mnn, type = "jaccard", use.dimred = "corrected")

com <- igraph::cluster_louvain(snn)
```

Tabulate number of cells from multiple batches within each cluster:

```{r}
tab <- table(Cluster = com$membership, Batch = mnn$batch)

col <- colorRampPalette(RColorBrewer::brewer.pal(n = 5, name = "Blues"))(100)

brk <- seq(0, max(tab), length.out = 101)

pheatmap(tab[, idx], color = col, display_numbers = TRUE, number_format = "%d", cluster_cols = FALSE, cluster_rows = FALSE, angle_col = 0)
```

Perform TSNE on the corrected PCA matrix:

```{r}
set.seed(42)

mnn <- runTSNE(mnn, dimred = "corrected", perplexity = 120) # same settings as reference analysis
```

Visualize the corrected PCA using a TSNE plot:

```{r fig.width = 9, fig.height = 9}
ggcells(mnn, aes(TSNE.1, TSNE.2, colour = celltype.mapped)) + 
  geom_point(size = 0.1, show.legend = FALSE) + 
  scale_colour_manual(values = EmbryoCelltypeColours) + 
  labs(x = "TSNE 1", y = "TSNE 2") + 
  facet_grid(source ~ stage.mapped) + 
  theme_bw() + 
  theme(aspect.ratio = 1)
```

Perform UMAP on the corrected PCA matrix:

```{r}
set.seed(42)

mnn <- runUMAP(mnn, dimred = "corrected", n_neighbors = 20, min_dist = 0.7) # same settings as reference analysis
```

Visualize the corrected PCA using a UMAP plot:

```{r fig.width = 9, fig.height = 9}
ggcells(mnn, aes(UMAP.1, UMAP.2, colour = celltype.mapped)) + 
  geom_point(size = 0.1, show.legend = FALSE) + 
  scale_colour_manual(values = EmbryoCelltypeColours) + 
  labs(x = "UMAP 1", y = "UMAP 2") + 
  facet_grid(source ~ stage.mapped) + 
  theme_no_axes() + 
  theme(aspect.ratio = 1)
```

## Summary

### Output

Save integrated experiment object to disk:

```{r}
saveRDS(mnn, file = "output/11-atlas-neighbors.rds")
```

### Session

Print session information:

```{r}
sessionInfo()
```
